import pprint
from music import *
from fractions import Fraction

ex_tabs = [
#"""
#E4
#B4
#G3
#D3
#A3
#E2
#""",
"""
E4|--------|--------|--------|--------|--------|--------|--------|--------------|--------------|
B4|--------|--------|--------|--------|--------|--------|--------|--------------|--------------|
G3|--------|4---4 -2|--------|4   4 -2|--------|4 --4 -2|--------|4 -2-2--------|4 -2-2--------|
D3|-------2|4---4 -2|-------2|4   4 -2|-------2|4 --4 -2|-------2|4 -2-2-2 -----|4 -2-2-2 -----|
A3|-----04-|2---2 -0|-----04-|2   2 -0|-----04-|2 --2 -0|-----04-|2 -0-0-2 --040|2 -0-0-2 --040|
E2|---04---|------4-|---04---|------4-|---04---|------4-|---04---|-------0 24---|-------0 24---|
""",
"""
|---0  ------|---------0 0|---------0 0|---------0 -|---------0 -|---0 -------|
|----0 ------|---------0 0|---------0 0|---------0 -|---------0 -|--0---------|
|--4--4---6--|------------|------------|------------|------------|---------6  |
|-4------4-4-|4-4  4 -----|4-4  4 -----|4 4 -4-2 --2|4 4 -4-2 ---|9 -------6  |
|2------6---6|4-4  4 -----|4-4  4 -----|4 4 -4-2 --2|4 4 -4-2 ---|9 ---96  6  |
|------4-----|2-2  2 0 ---|2-2  2 0 ---|2 2 02-0 --0|2 2 02-0 ---|7 ---74  4  |
""",
"""
|--------|--------------|--------------|--------------|--------------|--------------|
|--------|--0---0-------|--0---0-------|--------------|--------------|--------------|
|--------|--4---4-------|--4---4-------|--------------|--------------|--------------|
|4 4 ---4| 4---2--------|-4---2--------|--------------|--------------|--------------|
|4 4 ---2| --0 ------040|2--0 ------040|--------------|--------------|--------------|
|2 2 ----|-------0 24---|-------0 24---|--------------|--------------|--------------|
"""
          ]



def read (tabs):
  if not hasattr(tabs, '__iter__'):
    tabs = [tabs]

  signature = '4/4'
  deflen = Fraction(1, 8)
  musics = []
  strings = [tab.splitlines() for tab in tabs]
  strings = [''.join(l) for l in zip(*strings)]
  pprint.pprint(strings)
  for string in strings:
    if not string:
      continue
    string_pitch, bars = string.split('|', 1)
    music = []
    #for bar in bars[1:]:
    for beat in bars:
      if beat == '-':
        if music and music[-1][0] == ';' and music[-1][1] < 1:
          music[-1][1] += deflen
        else:
          music.append([';', deflen])
      elif beat == ' ':
        music[-1][1] += deflen
        print("new len", music[-1][1])
      elif beat.isdigit():
        music.append([offset(string_pitch, int(beat)), deflen])
      else:
        print(beat, 'was not valid')

    print(len(music))
    musics.append('/8 ' + ' '.join('/'.join(
      filter(None, (note, None if dur == deflen else to_dotted(dur))))
      for note, dur in music))


  pprint.pprint(musics)
  return musics


if __name__ == '__main__':
  import pprint
  pprint.pprint(read(ex_tabs))


